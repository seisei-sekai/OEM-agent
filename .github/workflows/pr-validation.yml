name: PR Validation & DDD Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

jobs:
  test-and-validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for diff analysis
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run linter
        run: pnpm lint
        continue-on-error: false
      
      - name: Run type check
        run: pnpm type-check
        continue-on-error: false
      
      - name: Run tests with coverage
        run: pnpm test --coverage
        continue-on-error: false
      
      - name: Validate DDD architecture
        run: pnpm ddd:validate
        continue-on-error: true  # Warning only
      
      - name: Generate DDD diff diagrams
        run: |
          pnpm ddd:diff --base-branch ${{ github.base_ref }} --pr-number ${{ github.event.pull_request.number }}
        continue-on-error: true  # May fail if no snapshots
      
      - name: Analyze code changes
        id: analyze
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.base_ref }}...HEAD | wc -l)
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          # Count domain changes
          DOMAIN_CHANGES=$(git diff --name-only ${{ github.base_ref }}...HEAD | grep "packages/domain" | wc -l)
          echo "domain_changes=$DOMAIN_CHANGES" >> $GITHUB_OUTPUT
          
          # Count test changes
          TEST_CHANGES=$(git diff --name-only ${{ github.base_ref }}...HEAD | grep "test.ts" | wc -l)
          echo "test_changes=$TEST_CHANGES" >> $GITHUB_OUTPUT
      
      # Comment on PR - Disabled (using CodeRabbit for comments)
      # Uncomment if you want both automated comments
      # - name: Comment on PR
      #   uses: actions/github-script@v7
      #   with:
      #     script: |
      #       const changedFiles = '${{ steps.analyze.outputs.changed_files }}';
      #       const domainChanges = '${{ steps.analyze.outputs.domain_changes }}';
      #       const testChanges = '${{ steps.analyze.outputs.test_changes }}';
      #       
      #       const comment = `## ü§ñ Automated PR Analysis
      #       
      #       ### üìä Change Statistics
      #       - **Files Changed:** ${changedFiles}
      #       - **Domain Layer Changes:** ${domainChanges}
      #       - **Test Files:** ${testChanges}
      #       
      #       ### ‚úÖ Validation Results
      #       - Tests: ${{ job.status }}
      #       - Type Check: Passed
      #       - DDD Validation: See workflow logs
      #       
      #       ### üìê DDD Architecture
      #       DDD diff diagrams have been generated. View the comparison:
      #       - [DDD Changes](../docs/ddd-changes/PR-${{ github.event.pull_request.number }}/comparison.md)
      #       
      #       ### üéØ Review Checklist
      #       - [ ] Domain logic in correct layer
      #       - [ ] Tests cover edge cases
      #       - [ ] No breaking changes
      #       - [ ] Documentation updated
      #       
      #       ---
      #       *Generated by PR Validation workflow*
      #       `;
      #       
      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: comment
      #       });
      
      - name: Upload DDD diff as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ddd-diff-diagrams
          path: docs/ddd-changes/PR-${{ github.event.pull_request.number }}/
          retention-days: 30
      
      - name: Check test coverage threshold
        run: |
          # This is a simple check - you may want to use a proper coverage tool
          echo "Checking coverage threshold..."
          # TODO: Add actual coverage threshold check
      
      - name: Commit DDD diff to PR
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -d "docs/ddd-changes/PR-${{ github.event.pull_request.number }}" ]; then
            git add docs/ddd-changes/PR-${{ github.event.pull_request.number }}/
            git diff --staged --quiet || git commit -m "docs: add DDD diff diagrams for PR #${{ github.event.pull_request.number }} [skip ci]"
            git push
          fi
